<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>시선 성대점 이벤트 페이지</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: 'Comic Sans MS', cursive, sans-serif; background: linear-gradient(135deg,#f9f9f9,#e6f7ff); color: #333; text-align: center; padding: 20px; min-height: 100vh; }
.chart-title { color: #4a90e2; margin-bottom: 18px; }
#marketStatus { background-color: #D62A2A; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.9em; margin-left: 10px; display: none; }
#currentPrice { display: block; margin-top: 10px; font-size: 60%; color:#333; font-weight:bold; }
.chart-container { width: 100%; max-width: 900px; height: 420px; margin: 0 auto; }
canvas { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
button { border-radius: 20px !important; padding: 12px 20px !important; margin: 6px; font-weight: 600; font-size: 16px; }
@media (max-width: 576px){ button { padding: 16px 24px !important; font-size: 18px; } }
.wheel-container { width: 100%; max-width: 420px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 18px; position: relative; display: flex; flex-direction: column; align-items: center; }
.wheel-visual { width: 100%; max-width: 380px; position: relative; margin-top: 8px; display: flex; justify-content: center; align-items: center; }
#wheelCanvas { width: 100%; height: auto; display: block; border-radius: 12px; background: #fafafa; }
#pointer { width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 28px solid red; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); z-index: 20; }
.option-input { width: 48%; margin: 4px 1%; }
.arrow-container { display: flex; justify-content: center; margin-top: 10px; gap: 10px; }
.arrow-container button { padding: 10px 14px; }
</style>
</head>
<body>
<div class="container mt-4">
  <ul class="nav nav-tabs" id="mainTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chartTab" type="button">📈 차트</button></li>
    <li class="nav-item"><button class="nav-link" id="wheel-tab" data-bs-toggle="tab" data-bs-target="#wheelTab" type="button">🎯 원판돌리기</button></li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="chartTab">
      <h2 class="chart-title mt-3">
        시선 B.C
        <span id="marketStatus" class="badge">장 마감</span>
      </h2>
      <div class="chart-container"><canvas id="chart" height="420"></canvas></div>
      <span id="currentPrice">현재가격: 5000원</span>

      <div class="d-flex flex-wrap justify-content-center mt-3 align-items-center">
        <button id="btnLowest" class="btn btn-success me-3 mb-2"><i class="fas fa-arrow-down"></i> 오늘의 최저가</button>
        <button id="btnLatest" class="btn btn-primary mb-2"><i class="fas fa-sync-alt"></i> 최신 보기</button>
      </div>
      <div class="d-flex justify-content-center mt-2 mb-1 text-center">
        <small>⬅️ 좌/우 화살표 버튼으로 과거/최신 데이터 탐색 ➡️</small>
      </div>
      <div class="arrow-container">
        <button id="btnPrev" class="btn btn-secondary"><i class="fas fa-arrow-left"></i></button>
        <button id="btnNext" class="btn btn-secondary"><i class="fas fa-arrow-right"></i></button>
      </div>
    </div>

    <div class="tab-pane fade" id="wheelTab">
      <div class="wheel-container">
        <h2>돌릴까말까 돌림판</h2>
        <div class="controls mb-2">옵션 개수:
          <button onclick="changeOptionCount(-1)">-</button>
          <span id="optionCount">6</span>
          <button onclick="changeOptionCount(1)">+</button>
          <small>(2~8개 설정가능)</small>
        </div>
        <div class="inputs d-flex flex-wrap justify-content-center mb-2" id="optionInputs"></div>
        <div class="wheel-visual">
          <div id="pointer" aria-hidden="true"></div>
          <canvas id="wheelCanvas" width="400" height="400"></canvas>
        </div>
        <button class="btn btn-warning mt-3" onclick="spinWheel()">돌려! 🐶</button>
        <h3 id="result" class="mt-3"></h3>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){
    const visiblePoints = 20, scrollStep = 10;
    let scrollStart = 0, firstLoad = true;
    let timestamps = ["시작"], prices = [5000];

    const ctxChart = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctxChart, {
        type:'line',
        data: { labels: timestamps, datasets:[{
            label:'가상코인', data: prices,
            borderColor:'rgb(75,192,192)', backgroundColor:'rgba(75,192,192,0.15)',
            pointRadius:5, pointBackgroundColor:'white', pointBorderColor:'rgb(75,192,192)', tension:0.2
        }]},
        options:{
            responsive:true, maintainAspectRatio:false,
            scales:{ x:{ticks:{maxRotation:45,minRotation:45}}, y:{min:2500,max:5000,ticks:{stepSize:500,callback:v=>v+'원'}}},
            plugins:{legend:{display:false}}
        }
    });

    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnLatest = document.getElementById('btnLatest');
    const btnLowest = document.getElementById('btnLowest');
    const marketStatus = document.getElementById('marketStatus');
    const currentPriceEl = document.getElementById('currentPrice');

    btnPrev.addEventListener('click', ()=>{scrollStart=Math.max(0,scrollStart-scrollStep); renderWindow();});
    btnNext.addEventListener('click', ()=>{scrollStart=Math.min(Math.max(0,timestamps.length-visiblePoints),scrollStart+scrollStep); renderWindow();});
    btnLatest.addEventListener('click', ()=>{scrollStart=Math.max(0,timestamps.length-visiblePoints); renderWindow();});
    btnLowest.addEventListener('click', ()=>{if(prices.length>0) alert("오늘의 최저가는 📉 "+Math.min(...prices)+"원 입니다!");});

    function updateNavButtons(){
        btnPrev.disabled = (scrollStart<=0);
        btnNext.disabled = (scrollStart+visiblePoints>=timestamps.length);
    }
    function renderWindow(){
        scrollStart=Math.max(0,Math.min(scrollStart,Math.max(0,timestamps.length-visiblePoints)));
        chart.data.labels = timestamps.slice(scrollStart,scrollStart+visiblePoints);
        chart.data.datasets[0].data = prices.slice(scrollStart,scrollStart+visiblePoints);
        chart.update();
        updateNavButtons();
    }

    // ===== 더미 데이터로 fetch 대체 =====
    async function fetchData(){
        try{
            const json = {
                timestamps: ["1","2","3","4","5","6","7","8","9","10"],
                prices: [5000,4800,4700,4900,5000,5050,4950,5000,5020,4980],
                market_open: true
            };

            if(firstLoad){
                firstLoad=false;
                timestamps = ["시작"].concat(json.timestamps);
                prices = [5000].concat(json.prices);
            } else {
                timestamps = json.timestamps.slice();
                prices = json.prices.slice();
            }

            marketStatus.style.display = json.market_open ? "none" : "inline-block";
            const latestPrice = prices.length > 0 ? prices[prices.length-1] : 5000;
            currentPriceEl.textContent = "현재가격: " + latestPrice + "원";

            renderWindow();
        } catch(e){ console.error(e); }
    }

    setInterval(fetchData, 150000); // 5초마다 갱신
    fetchData();
});

// ===== 원판 돌리기 =====
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");
let optionCount = 6, options = Array(optionCount).fill(""), startAngle = 0, spinning=false;
const colors = ["#FF9999","#FFCC66","#99CCFF","#99FF99","#FF9966","#CC99FF","#66CCCC","#FF6666"];

function changeOptionCount(delta){
    optionCount = Math.min(8, Math.max(2, optionCount+delta));
    document.getElementById("optionCount").textContent = optionCount;
    options = Array(optionCount).fill("");
    renderInputs();
    drawWheel();
}
function renderInputs(){
    const container=document.getElementById("optionInputs");
    container.innerHTML="";
    options.forEach((val,i)=>{
        const input=document.createElement("input");
        input.placeholder=`옵션 ${i+1}`;
        input.value=val;
        input.className="option-input form-control";
        input.oninput = e => {options[i]=e.target.value; drawWheel();};
        container.appendChild(input);
    });
}
function drawWheel(){
    const rect = canvas.getBoundingClientRect();
    if(canvas.width !== Math.floor(rect.width)){
        canvas.width = Math.floor(rect.width);
        canvas.height = Math.floor(rect.width);
    }
    const radius = Math.min(rect.width, rect.height)/2*0.9;
    const centerX = rect.width/2;
    const centerY = rect.height/2;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    const arc = 2*Math.PI/optionCount;
    for(let i=0;i<optionCount;i++){
        const angle=startAngle+i*arc;
        ctx.beginPath();
        ctx.moveTo(centerX,centerY);
        ctx.arc(centerX,centerY,radius,angle,angle+arc);
        ctx.closePath();
        ctx.fillStyle=colors[i%colors.length];
        ctx.fill();
        ctx.stroke();

        ctx.save();
        ctx.translate(centerX,centerY);
        ctx.rotate(angle+arc/2);
        ctx.textAlign="right";
        ctx.fillStyle="#fff";
        ctx.font=`${Math.floor(radius/10)}px Arial`;
        ctx.fillText(options[i]||`옵션${i+1}`, radius-20, 10);
        ctx.restore();
    }
}

function spinWheel(){
    if(spinning) return;
    spinning = true;
    let spinAngle = Math.random()*360+1800;
    let duration = 4000;
    let start = performance.now();
    function animate(now){
        let elapsed = now-start;
        if(elapsed<duration){
            let progress = elapsed/duration;
            let easeOut = 1-Math.pow(1-progress,3);
            startAngle = (spinAngle*easeOut)*Math.PI/180;
            drawWheel();
            requestAnimationFrame(animate);
        } else {
            spinning=false;
            startAngle=(spinAngle*Math.PI/180)%(2*Math.PI);
            drawWheel();
            declareWinner();
        }
    }
    requestAnimationFrame(animate);
}
function declareWinner(){
    const arc = 2*Math.PI/optionCount;
    const pointerAngle = (3*Math.PI/2 - startAngle + 2*Math.PI)%(2*Math.PI);
    const winningIndex = Math.floor(pointerAngle/arc)%optionCount;
    const winner = options[winningIndex]||`옵션${winningIndex+1}`;
    document.getElementById("result").textContent = `당첨: ${winner}`;
}

renderInputs();
drawWheel();
window.addEventListener('resize', drawWheel);
</script>
</body>
</html>